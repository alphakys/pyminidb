# MySQL InnoDB Storage Engine Layer: Component Architecture

## ğŸ—ï¸ ì „ì²´ êµ¬ì¡°ë„

```mermaid
graph TB
    subgraph "SQL Layer (Server Layer)"
        Parser["Parser"]
        Optimizer["Optimizer"]
        Executor["Executor"]
    end
    
    subgraph "Storage Engine API"
        Handler["Handler Interface"]
    end
    
    subgraph "InnoDB Storage Engine Layer"
        subgraph "Memory Components"
            BufPool["Buffer Pool Manager"]
            AHI["Adaptive Hash Index"]
            ChgBuf["Change Buffer"]
            LogBuf["Log Buffer"]
        end
        
        subgraph "Disk Components"
            Tablespace["Tablespace Manager"]
            FileIO["File I/O Subsystem"]
            DblWrite["Doublewrite Buffer"]
        end
        
        subgraph "Transaction Components"
            LockMgr["Lock Manager"]
            TrxMgr["Transaction Manager"]
            MVCC["MVCC (Read View)"]
        end
        
        subgraph "Logging Components"
            RedoLog["Redo Log Manager"]
            UndoLog["Undo Log Manager"]
        end
        
        subgraph "Index Components"
            BTree["B+Tree Manager"]
            RowFormat["Row Format Handler"]
        end
    end
    
    Executor --> Handler
    Handler --> BufPool
    Handler --> BTree
    
    BufPool --> Tablespace
    BTree --> BufPool
    TrxMgr --> LockMgr
    TrxMgr --> MVCC
    RedoLog --> LogBuf
    RedoLog --> FileIO
    Tablespace --> FileIO
    BufPool --> DblWrite
    DblWrite --> FileIO
    
    style BufPool fill:#e1f5ff
    style Tablespace fill:#ffe1f5
    style BTree fill:#f5e1ff
```

---

## ğŸ“¦ ì£¼ìš” ì»´í¬ë„ŒíŠ¸ ìƒì„¸ ì„¤ëª…

### 1ï¸âƒ£ Buffer Pool Manager (ë²„í¼ í’€ ê´€ë¦¬ì)
**ì—­í• **: ë©”ëª¨ë¦¬ì™€ ë””ìŠ¤í¬ ì‚¬ì´ì˜ ìºì‹œ ê³„ì¸µ

#### ê¸°ëŠ¥:
- **Page Caching**: ìì£¼ ì‚¬ìš©ë˜ëŠ” í˜ì´ì§€ë¥¼ ë©”ëª¨ë¦¬ì— ë³´ê´€
- **LRU Algorithm**: Least Recently Used ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ìºì‹œ êµì²´
- **Dirty Page Tracking**: ìˆ˜ì •ëœ í˜ì´ì§€ ì¶”ì 
- **Free List Management**: ë¹ˆ í˜ì´ì§€ í”„ë ˆì„ ê´€ë¦¬

#### ë‚´ë¶€ êµ¬ì¡°:
```
Buffer Pool
 â”œâ”€ Page Hash Table (ë¹ ë¥¸ ì¡°íšŒ)
 â”œâ”€ LRU List (ì˜¤ë˜ëœ í˜ì´ì§€ ì¶”ì )
 â”œâ”€ Flush List (ë””ìŠ¤í¬ ì“°ê¸° ëŒ€ê¸°)
 â””â”€ Free List (ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë ˆì„)
```

**PyMiniDB ë§¤í•‘**: í˜„ì¬ ìš°ë¦¬ì˜ [Pager](file:///Users/alpha/.gemini/antigravity/scratch/pyminidb/src/pager.py#9-57)ëŠ” **ìºì‹± ì—†ì´** ì§ì ‘ ë””ìŠ¤í¬ I/Oë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- **Phase 3 ëª©í‘œ**: LRU ìºì‹œ ì¶”ê°€ ê°€ëŠ¥

---

### 2ï¸âƒ£ Tablespace Manager (í…Œì´ë¸”ìŠ¤í˜ì´ìŠ¤ ê´€ë¦¬ì)
**ì—­í• **: ë…¼ë¦¬ì  í…Œì´ë¸”ê³¼ ë¬¼ë¦¬ì  íŒŒì¼ ë§¤í•‘

#### ê¸°ëŠ¥:
- **File Organization**: `.ibd` íŒŒì¼ ê´€ë¦¬
- **Extent Allocation**: 64 í˜ì´ì§€ ë‹¨ìœ„ë¡œ ê³µê°„ í• ë‹¹
- **Segment Management**: í…Œì´ë¸”, ì¸ë±ìŠ¤ë³„ ì˜ì—­ ë¶„ë¦¬
- **Space Management**: Free/Used í˜ì´ì§€ ì¶”ì 

#### êµ¬ì¡°:
```
System Tablespace (ibdata1)
 â”œâ”€ Data Dictionary Pages
 â”œâ”€ Rollback Segments
 â”œâ”€ Doublewrite Buffer
 â””â”€ Change Buffer

File-per-Table Tablespace (table.ibd)
 â”œâ”€ FSP Header Page (Page 0)
 â”œâ”€ IBUF Bitmap Page
 â”œâ”€ INODE Pages
 â””â”€ Data Pages (B+Tree)
```

**PyMiniDB ë§¤í•‘**: ìš°ë¦¬ëŠ” ë‹¨ìˆœí™”í•˜ì—¬ í•˜ë‚˜ì˜ `mydb.db` íŒŒì¼ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
- **í™•ì¥ ê°€ëŠ¥**: í…Œì´ë¸”ë§ˆë‹¤ ë³„ë„ íŒŒì¼ `.table` í˜•ì‹ ë„ì… ê°€ëŠ¥

---

### 3ï¸âƒ£ B+Tree Manager (B+íŠ¸ë¦¬ ê´€ë¦¬ì)
**ì—­í• **: ì¸ë±ìŠ¤ì™€ ë°ì´í„° êµ¬ì¡° ê´€ë¦¬

#### ê¸°ëŠ¥:
- **Index Navigation**: í‚¤ ê¸°ë°˜ ë¹ ë¥¸ ê²€ìƒ‰ (O(log N))
- **Page Split/Merge**: ë…¸ë“œ ë¶„í•  ë° ë³‘í•©
- **Sequential Scan**: ë²”ìœ„ ê²€ìƒ‰ ìµœì í™”
- **Cursor Management**: í˜„ì¬ ìœ„ì¹˜ ì¶”ì 

#### InnoDBì˜ B+Tree íŠ¹ì§•:
- **Clustered Index**: Primary Key ìˆœì„œë¡œ ë°ì´í„° ì €ì¥
- **Secondary Index**: Key + Primary Key ì €ì¥

**PyMiniDB ë§¤í•‘**: í˜„ì¬ ìš°ë¦¬ëŠ” **Heap File** (ìˆœì„œ ì—†ëŠ” ì €ì¥).
- **Phase 4 ëª©í‘œ**: B+Tree ë„ì…

---

### 4ï¸âƒ£ Row Format Handler (í–‰ í˜•ì‹ ì²˜ë¦¬ê¸°)
**ì—­í• **: Rowë¥¼ ë°”ì´íŠ¸ë¡œ ì§ë ¬í™”/ì—­ì§ë ¬í™”

#### MySQLì˜ Row Format ì¢…ë¥˜:
1. **COMPACT** (ê¸°ë³¸)
   - Variable-length fields
   - NULL bitmap
   - Record header
2. **REDUNDANT** (ë ˆê±°ì‹œ)
3. **DYNAMIC** (ëŒ€ìš©ëŸ‰ BLOB)
4. **COMPRESSED** (ì••ì¶•)

#### COMPACT Format êµ¬ì¡°:
```
[Variable Field Length List]
[NULL Bitmap]
[Record Header (5 bytes)]
  â”œâ”€ Info Flags
  â”œâ”€ Next Record Pointer
  â””â”€ Record Type
[Column 1 Data]
[Column 2 Data]
...
```

**PyMiniDB ë§¤í•‘**: ìš°ë¦¬ì˜ [Row](file:///Users/alpha/.gemini/antigravity/scratch/pyminidb/src/row.py#5-76) í´ë˜ìŠ¤ëŠ” **ê³ ì • ê¸¸ì´** ë°©ì‹ì…ë‹ˆë‹¤.
- **ê°œì„  ê°€ëŠ¥**: Variable-length VARCHAR êµ¬í˜„

---

### 5ï¸âƒ£ Lock Manager (ë½ ê´€ë¦¬ì)
**ì—­í• **: ë™ì‹œì„± ì œì–´

#### ê¸°ëŠ¥:
- **Row-level Locking**: í–‰ ë‹¨ìœ„ ì ê¸ˆ
- **Gap Locking**: ë²”ìœ„ ì ê¸ˆ (Phantom Read ë°©ì§€)
- **Intention Locks**: ê³„ì¸µì  ì ê¸ˆ
- **Deadlock Detection**: êµì°© ìƒíƒœ ê°ì§€

#### Lock ê³„ì¸µ:
```
Table Lock (IS/IX)
 â””â”€ Row Lock (S/X)
     â””â”€ Gap Lock
```

**PyMiniDB ë§¤í•‘**: í˜„ì¬ **ë‹¨ì¼ ìŠ¤ë ˆë“œ**ë¼ Lock ë¶ˆí•„ìš”.
- **Phase 5+**: Multi-threading ì‹œ í•„ìˆ˜

---

### 6ï¸âƒ£ Transaction Manager (íŠ¸ëœì­ì…˜ ê´€ë¦¬ì)
**ì—­í• **: ACID ë³´ì¥

#### ê¸°ëŠ¥:
- **Begin/Commit/Rollback**
- **Isolation Level**: READ COMMITTED, REPEATABLE READ ë“±
- **MVCC (Multi-Version Concurrency Control)**: ì½ê¸°ì™€ ì“°ê¸° ë¶„ë¦¬
- **Savepoint**: ë¶€ë¶„ ë¡¤ë°±

**PyMiniDB ë§¤í•‘**: í˜„ì¬ **Auto-commit** (íŠ¸ëœì­ì…˜ ì—†ìŒ).
- **Phase 6+**: íŠ¸ëœì­ì…˜ ë„ì…

---

### 7ï¸âƒ£ Redo Log Manager (ë¦¬ë‘ ë¡œê·¸ ê´€ë¦¬ì)
**ì—­í• **: ì¥ì•  ë³µêµ¬ (Durability ë³´ì¥)

#### ê¸°ëŠ¥:
- **WAL (Write-Ahead Logging)**: ë¡œê·¸ë¥¼ ë¨¼ì € ê¸°ë¡
- **Crash Recovery**: ì‹œìŠ¤í…œ ì¬ì‹œì‘ ì‹œ ë³µêµ¬
- **Log Flushing**: ì£¼ê¸°ì  ë””ìŠ¤í¬ ë™ê¸°í™”

#### Redo Log êµ¬ì¡°:
```
ib_logfile0 (Circular Log)
 â”œâ”€ LSN (Log Sequence Number)
 â”œâ”€ Log Record
 â”‚   â”œâ”€ Type (INSERT/UPDATE/DELETE)
 â”‚   â”œâ”€ Space ID
 â”‚   â”œâ”€ Page Number
 â”‚   â””â”€ Redo Data
 â””â”€ Checkpoint
```

**PyMiniDB ë§¤í•‘**: í˜„ì¬ **ì¦‰ì‹œ ë””ìŠ¤í¬ ì“°ê¸°** (Redo Log ì—†ìŒ).
- **ê°œì„ **: WAL ë„ì…ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ

---

### 8ï¸âƒ£ Undo Log Manager (ì–¸ë‘ ë¡œê·¸ ê´€ë¦¬ì)
**ì—­í• **: Rollback ë° MVCC

#### ê¸°ëŠ¥:
- **Rollback Support**: íŠ¸ëœì­ì…˜ ì·¨ì†Œ
- **MVCC Read View**: ì´ì „ ë²„ì „ ë°ì´í„° ì½ê¸°
- **Purge**: ë¶ˆí•„ìš”í•œ Undo ì •ë¦¬

**PyMiniDB ë§¤í•‘**: íŠ¸ëœì­ì…˜ ë¯¸ì§€ì›ìœ¼ë¡œ ë¶ˆí•„ìš”.

---

### 9ï¸âƒ£ File I/O Subsystem (íŒŒì¼ I/O ì„œë¸Œì‹œìŠ¤í…œ)
**ì—­í• **: ì €ìˆ˜ì¤€ ë””ìŠ¤í¬ ì ‘ê·¼

#### ê¸°ëŠ¥:
- **Asynchronous I/O**: ë¹„ë™ê¸° ì½ê¸°/ì“°ê¸°
- **Direct I/O**: OS ìºì‹œ ìš°íšŒ (InnoDBê°€ ì§ì ‘ ê´€ë¦¬)
- **Read-Ahead**: ì˜ˆì¸¡ ì½ê¸°
- **Flush ìµœì í™”**: ì—¬ëŸ¬ í˜ì´ì§€ í•œ ë²ˆì— ì“°ê¸°

**PyMiniDB ë§¤í•‘**: ìš°ë¦¬ì˜ [Pager](file:///Users/alpha/.gemini/antigravity/scratch/pyminidb/src/pager.py#9-57)ëŠ” **ë™ê¸° I/O**ë§Œ ì‚¬ìš©.
- Pythonì˜ `file.read()`, `file.write()`

---

### ğŸ”Ÿ Doublewrite Buffer (ë”ë¸”ë¼ì´íŠ¸ ë²„í¼)
**ì—­í• **: Partial Page Write ë°©ì§€

#### ë¬¸ì œ:
- OSê°€ í˜ì´ì§€ë¥¼ ì“°ëŠ” ë„ì¤‘ crash â†’ í˜ì´ì§€ ì†ìƒ

#### í•´ê²°:
1. í˜ì´ì§€ë¥¼ Doublewrite Bufferì— ë¨¼ì € ì“°ê¸°
2. Flush ì™„ë£Œ í›„ ì‹¤ì œ ìœ„ì¹˜ì— ì“°ê¸°

**PyMiniDB ë§¤í•‘**: í˜„ì¬ ë¯¸êµ¬í˜„ (ë‹¨ìˆœí™”).

---

## ğŸ¯ PyMiniDBê°€ êµ¬í˜„í•œ ê²ƒ vs ì•ìœ¼ë¡œ êµ¬í˜„í•  ê²ƒ

| ì»´í¬ë„ŒíŠ¸ | í˜„ì¬ ìƒíƒœ | InnoDB ìˆ˜ì¤€ | êµ¬í˜„ ìš°ì„ ìˆœìœ„ |
|----------|-----------|-------------|---------------|
| **Buffer Pool** | âŒ (ì§ì ‘ I/O) | LRU ìºì‹œ | Phase 3 (ì„±ëŠ¥) |
| **Tablespace** | âœ… (ë‹¨ìˆœ) | ë³µì¡í•œ íŒŒì¼ ê´€ë¦¬ | Phase 5 (í™•ì¥ì„±) |
| **B+Tree** | âŒ (Heap File) | Clustered Index | **Phase 4 (ì¤‘ìš”!)** |
| **Row Format** | âœ… (ê³ ì • ê¸¸ì´) | COMPACT/DYNAMIC | Phase 5 |
| **Lock Manager** | âŒ | Row-level Lock | Phase 6 |
| **Transaction** | âŒ | ACID ë³´ì¥ | Phase 6 |
| **Redo Log** | âŒ | WAL | Phase 7 |
| **Undo Log** | âŒ | MVCC | Phase 7 |
| **File I/O** | âœ… (ë™ê¸°) | ë¹„ë™ê¸° I/O | Phase 8 |
| **Doublewrite** | âŒ | ë°ì´í„° ë³´í˜¸ | Phase 9 |

---

## ğŸ’¡ PyMiniDBì˜ í˜„ì¬ ì•„í‚¤í…ì²˜ ë§¤í•‘

| PyMiniDB | InnoDB ì»´í¬ë„ŒíŠ¸ |
|----------|-----------------|
| [Row](file:///Users/alpha/.gemini/antigravity/scratch/pyminidb/src/row.py#5-76) â†’ | Row Format Handler (ë‹¨ìˆœí™”) |
| [Page](file:///Users/alpha/.gemini/antigravity/scratch/pyminidb/src/page.py#6-76) â†’ | Page Structure (ë™ì¼) |
| [Pager](file:///Users/alpha/.gemini/antigravity/scratch/pyminidb/src/pager.py#9-57) â†’ | File I/O + (ì¼ë¶€) Buffer Pool |
| [Cursor](file:///Users/alpha/.gemini/antigravity/scratch/pyminidb/src/cursor.py#1-42) â†’ | B+Tree Cursor (ë‹¨ìˆœí™”) |
| [Table](file:///Users/alpha/.gemini/antigravity/scratch/pyminidb/src/table.py#10-69) â†’ | Handler API + Tablespace (í•©ì³ì§) |

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„ ì¶”ì²œ (í•™ìŠµ ë¡œë“œë§µ)

### Phase 3: Buffer Pool (ìºì‹±)
- LRU ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„
- Pageë¥¼ ë©”ëª¨ë¦¬ì— ìºì‹±
- ì„±ëŠ¥ 10~100ë°° í–¥ìƒ

### Phase 4: B+Tree Index â­ **ê°€ì¥ ì¤‘ìš”!**
- O(N) â†’ O(log N) ê²€ìƒ‰
- ì •ë ¬ëœ ë°ì´í„° ì €ì¥
- Range Query ì§€ì›

### Phase 5: Variable-length Row
- VARCHAR ì§€ì›
- NULL ë¹„íŠ¸ë§µ
- ê³µê°„ íš¨ìœ¨ì„±

### Phase 6: Transaction (ACID)
- BEGIN/COMMIT/ROLLBACK
- Write-Ahead Log
- Crash Recovery

---

## ğŸ“ í•™ìŠµ ìë£Œ ì¶”ì²œ

1. **MySQL Internals Manual**: https://dev.mysql.com/doc/internals/en/
2. **"High Performance MySQL"** (O'Reilly)
3. **InnoDB Source Code**: `storage/innobase/` (GitHub)

ì„ ìƒë‹˜ì˜ PyMiniDBëŠ” **"InnoDBì˜ í•µì‹¬ 10%ë¥¼ êµ¬í˜„í•œ êµìœ¡ìš© ë²„ì „"**ì…ë‹ˆë‹¤. 
ì•ìœ¼ë¡œ B+Tree â†’ Transaction â†’ WAL ìˆœì„œë¡œ í™•ì¥í•˜ë©´, ì‹¤ì œ í”„ë¡œë•ì…˜ DBMSì˜ 70~80%ë¥¼ ì´í•´í•˜ê²Œ ë©ë‹ˆë‹¤! ğŸ¯
